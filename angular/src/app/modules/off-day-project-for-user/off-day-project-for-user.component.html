<div class="row clearfix">
  <div class="card main-content" [busy]="isLoading">
    <div class="header">
      <h2 class="title">{{ "Team working calendar" | localize }}</h2>
      <div class="extra-action-group">
        <div class="date-and-button-group">
          <div class="filter-date-group">
            <mat-form-field appearance="outline" class="filter-item">
              <mat-label>Year</mat-label>
              <mat-select
                name="yearSelect"
                [(value)]="year"
                (selectionChange)="selectionChange()"
              >
                <mat-option *ngFor="let item of listYear" [value]="item">
                  {{ item }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field appearance="outline" class="filter-item">
              <mat-label>Month</mat-label>
              <mat-select
                name="monthSelect"
                [(value)]="month"
                (selectionChange)="selectionChange($event)"
              >
                <mat-option *ngFor="let item of listMonth" [value]="item">
                  {{ item + 1 }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>
        <div class="label-button-group">
          <div style="width: auto">
            <button
              *ngIf="shouldShowNotifyPmButton()"
              (click)="notifyApproveRequestOffToPM()"
              style="height: 44px"
              mat-flat-button
              color="primary"
            >
              Notify PM
            </button>
          </div>
          <div
            *ngIf="permission.isGranted(Export_Team_Working_Calender)"
            style="width: auto"
          >
            <button
              name="exportBtn"
              style="height: 44px"
              mat-flat-button
              (click)="onExport()"
              color="primary"
              [disabled]="isDisabled"
            >
              Export
            </button>
          </div>
        </div>
        <!-- <div>
            <div class="btn-group m-5">
              <div class="btn btn-primary" name="previousBtn" mwlCalendarPreviousView [view]="view" [(viewDate)]="viewDate"
                (viewDateChange)="closeOpenMonthViewDay()">
                Previous
              </div>
              <div class="btn btn-outline-secondary" name="currentDateBtn" mwlCalendarToday [(viewDate)]="viewDate"
                (viewDateChange)="closeOpenMonthViewDay()">
                Today
              </div>
              <div class="btn btn-primary" name="nextBtn" mwlCalendarNextView [view]="view" [(viewDate)]="viewDate"
                (viewDateChange)="closeOpenMonthViewDay()">
                Next
              </div>
            </div>
          </div> -->
        <div class="header-dropdown-mat-icon-button">
          <button
            name="menuBtn"
            mat-icon-button
            [matMenuTriggerFor]="headerMenu"
          >
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #headerMenu="matMenu">
            <button mat-menu-item (click)="refreshData()">
              <mat-icon>refresh</mat-icon>
              <span>{{ "Refresh" | localize }}</span>
            </button>
            <div class="menu-label-button-group">
              <button
                mat-menu-item
                *ngIf="shouldShowNotifyPmButton()"
                (click)="notifyApproveRequestOffToPM()"
              >
                <mat-icon>notifications_active</mat-icon>
                <span>{{ "Notify PM" | localize }}</span>
              </button>
              <button
                mat-menu-item
                (click)="refreshData()"
                *ngIf="permission.isGranted(Export_Team_Working_Calender)"
                (click)="onExport()"
                [disabled]="isDisabled"
              >
                <mat-icon>ios_share</mat-icon>
                <span>{{ "Export" | localize }}</span>
              </button>
            </div>
          </mat-menu>
        </div>
      </div>
    </div>
    <div class="filter-non-date-group">
      <mat-form-field appearance="outline" class="filter-item">
        <mat-label>Search by email</mat-label>
        <input
          name="searchText"
          matInput
          [(ngModel)]="searchText"
          (keyup.enter)="refreshData()"
        />
      </mat-form-field>
      <mat-form-field appearance="outline" class="filter-item">
        <mat-label>Status</mat-label>
        <mat-select
          name="dayAbsentStatus"
          [(value)]="dayAbsentStatus"
          (selectionChange)="selectionChange()"
        >
          <mat-option
            *ngFor="let item of dayAbsentStatusList"
            [value]="APP_CONSTANT.AbsenceStatusFilter[item]"
          >
            {{ item }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      <app-multiple-select
        name="listProject"
        labelName="Project"
        [listOption]="listProject"
        (onChange)="onChangeListProjectIdSelected($event)"
        [defaultValue]="listProjectSelected"
        [disabled]="isLoading"
      >
      </app-multiple-select>
      <mat-form-field appearance="outline" class="filter-item">
        <mat-label>Request Type</mat-label>
        <mat-select
          name="absentDayType"
          [(value)]="absentDayType"
          (selectionChange)="selectionChange()"
        >
          <mat-option [value]="-1">All</mat-option>
          <mat-option
            *ngFor="let item of dayAbsentTypeList"
            [value]="APP_CONSTANT.DayAbsenceType[item]"
          >
            {{ item }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field
        *ngIf="absentDayType === 2"
        appearance="outline"
        class="filter-item"
      >
        <mat-label>Remote of week</mat-label>
        <mat-select
          name="remoteOfWeek"
          [(value)]="remoteOfWeek"
          (selectionChange)="onRemoteOfWeekChange()"
        >
          <mat-option [value]="-1">All</mat-option>
          <mat-option *ngFor="let item of remoteOfWeekList" [value]="item">
            {{ item }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field
        *ngIf="absentDayType === 0"
        appearance="outline"
        class="filter-item"
      >
        <mat-label>Type Of Request Type</mat-label>
        <mat-select
          name="dayType"
          [(value)]="dayType"
          (selectionChange)="onDayTypeChange()"
        >
          <mat-option [value]="-1">All</mat-option>
          <mat-option
            *ngFor="let item of dayTypeList"
            [value]="APP_CONSTANT.AbsenceType[item]"
          >
            {{ item | dayType }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field
        *ngIf="absentDayType === 0"
        appearance="outline"
        class="filter-item"
      >
        <mat-label>Absence Type</mat-label>
        <mat-select
          name="dayOffType"
          [(value)]="dayOffType"
          (selectionChange)="onDayOffTypeChange()"
        >
          <mat-option [value]="-1">All</mat-option>
          <mat-option *ngFor="let type of dayOffTypes" [value]="type.id">{{
            type.name
          }}</mat-option>
        </mat-select>
      </mat-form-field>

      <button
        name="filterBtn"
        style="height: 44px; width: 40px; margin-top: 4px"
        mat-flat-button
        (click)="onFilter()"
        color="primary"
      >
        Filter
      </button>
    </div>
    <br />
    <div style="padding: 0px 20px 20px; overflow-x: scroll">
      <div [ngSwitch]="view">
        <mwl-calendar-month-view
          class="spe-wrap"
          *ngSwitchCase="CalendarView.Month"
          [cellTemplate]="customCellTemplate"
          [viewDate]="viewDate"
          [events]="events"
          [refresh]="refresh"
          [activeDayIsOpen]="activeDayIsOpen"
          (beforeViewRender)="getData($event)"
          (dayClicked)="dayClicked($event.day)"
        >
        </mwl-calendar-month-view>
      </div>
    </div>
  </div>
</div>

<ng-template #customCellTemplate let-day="day" let-locale="locale">
  <div
    class="cal-cell-top position-relative"
    [attr.name]="'daySelectBtn-' + (day.date | date : 'dd-MM-yyyy')"
    style="overflow: hidden"
  >
    <span class="cal-day-badge" *ngIf="day.cssClass == 'back-red'">Off</span>
    <!-- <span class="cal-day-badge" *ngIf="day.badgeTotal > 0 && day.cssClass != 'back-red'">{{day.badgeTotal}}</span> -->
    <span class="cal-day-number">{{
      day.date | calendarDate : "monthViewDayNumber" : locale
    }}</span>
    <div class="cal-day-item" style="cursor: pointer">
      <ng-container *ngFor="let event of events">
        <ng-container *ngIf="event.date.getTime() === day.date.getTime()">
          <div style="display: flex">
            <div style="display: flex; padding: 2px">
              <span
                class="cal-day-badge text-primary day-chip-full-day mr-1"
                *ngIf="
                  event.meta == 0 &&
                  event.absenceType != 1 &&
                  event.absenceType != 2 &&
                  event.absenceType != 3
                "
                style="width: fit-content"
              >
                <span style="float: left">Off: {{ event.count }}</span>
              </span>
              <span
                class="cal-day-badge text-primary onsite"
                *ngIf="event.meta == 1"
                style="width: fit-content"
              >
                <span style="float: left">Onsite: {{ event.count }}</span>
              </span>
              <span
                class="cal-day-badge text-primary remote"
                *ngIf="event.meta == 2"
                style="width: fit-content"
              >
                <span style="float: left">Remote: {{ event.count }}</span>
              </span>
              <span
                class="cal-day-badge text-primary day-chip-custom"
                *ngIf="
                  event.meta == 0 &&
                  event.absenceType == 1 &&
                  (dayType == 4 || absentDayType == -1)
                "
                style="width: fit-content"
              >
                <span style="float: left">ĐM: {{ event.count }}</span>
              </span>
              <span
                class="cal-day-badge text-primary day-chip-full-day"
                *ngIf="
                  event.meta == 0 &&
                  event.absenceType == 2 &&
                  (dayType == 4 || absentDayType == -1)
                "
                style="width: fit-content"
              >
                <span style="float: left">Off: {{ event.count }}</span>
              </span>
              <span
                class="cal-day-badge text-primary day-chip-custom"
                *ngIf="
                  event.meta == 0 &&
                  event.absenceType == 3 &&
                  (dayType == 4 || absentDayType == -1)
                "
                style="width: fit-content"
              >
                <span style="float: left">VS: {{ event.count }}</span>
              </span>
            </div>
          </div>
        </ng-container>
      </ng-container>
    </div>
  </div>
</ng-template>
